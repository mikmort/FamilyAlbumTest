<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InsightFace Test Harness</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .model-selector {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }

    .model-selector h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      flex: 1;
    }

    .radio-label:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .radio-label input {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .radio-label.selected {
      border-color: #667eea;
      background: #e7edff;
    }

    .model-info {
      flex: 1;
    }

    .model-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .model-desc {
      font-size: 0.9rem;
      color: #666;
    }

    .upload-section {
      margin-bottom: 30px;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: inline-block;
      padding: 15px 30px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 1.1rem;
    }

    .file-input-label:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .preview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    .preview-section {
      border: 2px dashed #dee2e6;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .preview-section h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .preview-section img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .results {
      margin-top: 30px;
    }

    .result-card {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .result-card h4 {
      color: #333;
      margin-bottom: 10px;
    }

    .match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid #dee2e6;
    }

    .match-name {
      font-weight: 600;
      color: #333;
    }

    .match-score {
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 4px;
      background: #d4edda;
      color: #155724;
    }

    .match-score.medium {
      background: #fff3cd;
      color: #856404;
    }

    .match-score.low {
      background: #f8d7da;
      color: #721c24;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .status.loading {
      background: #cfe2ff;
      color: #084298;
    }

    .status.success {
      background: #d1e7dd;
      color: #0f5132;
    }

    .status.error {
      background: #f8d7da;
      color: #842029;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }

    button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s;
    }

    button:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      background: #adb5bd;
      cursor: not-allowed;
      transform: none;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-column h4 {
      margin-bottom: 15px;
      color: #333;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß† InsightFace Test Harness</h1>
    <p class="subtitle">Compare face-api.js (128-dim) vs InsightFace (512-dim) recognition accuracy</p>

    <div class="model-selector">
      <h3>Select Recognition Model:</h3>
      <div class="radio-group">
        <label class="radio-label selected" id="label-insightface">
          <input type="radio" name="model" value="insightface" checked>
          <div class="model-info">
            <div class="model-name">InsightFace ArcFace ‚≠ê</div>
            <div class="model-desc">512-dim ‚Ä¢ 99.8% accuracy ‚Ä¢ Best for age progression</div>
          </div>
        </label>
        <label class="radio-label" id="label-face-api-js">
          <input type="radio" name="model" value="face-api-js">
          <div class="model-info">
            <div class="model-name">face-api.js (Legacy)</div>
            <div class="model-desc">128-dim ‚Ä¢ ~95% accuracy ‚Ä¢ Browser-based</div>
          </div>
        </label>
      </div>
    </div>

    <div class="upload-section">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept="image/*">
        <label for="fileInput" class="file-input-label">üì∑ Choose Photo to Test</label>
      </div>
      <div id="fileName" style="color: #666; margin-top: 10px;"></div>
    </div>

    <div class="preview" id="preview" style="display: none;">
      <div class="preview-section">
        <h3>Test Photo</h3>
        <img id="testImage" alt="Test photo">
        <div id="imageInfo"></div>
      </div>
      <div class="preview-section">
        <h3>Results</h3>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    let selectedModel = 'insightface';
    
    // Model selection
    document.querySelectorAll('input[name="model"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        selectedModel = e.target.value;
        document.querySelectorAll('.radio-label').forEach(label => {
          label.classList.remove('selected');
        });
        e.target.closest('.radio-label').classList.add('selected');
      });
    });

    // File upload
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('fileName').textContent = `Selected: ${file.name}`;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('testImage').src = e.target.result;
        document.getElementById('preview').style.display = 'grid';
      };
      reader.readAsDataURL(file);

      // Test recognition
      await testRecognition(file);
    });

    async function testRecognition(file) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="status loading">üîÑ Processing image...</div>';

      try {
        // Check if Python API is running
        if (selectedModel === 'insightface') {
          resultsDiv.innerHTML = '<div class="status loading">üîÑ Checking Python API availability...</div>';
          try {
            const healthCheck = await fetch('http://localhost:7072/api/generate-embeddings', { method: 'OPTIONS' });
            if (!healthCheck.ok && healthCheck.status !== 405) {
              throw new Error('Python API not responding');
            }
          } catch (healthError) {
            resultsDiv.innerHTML = `
              <div class="status error">
                ‚ùå Python API not available on port 7072
                <p style="margin-top: 10px; font-size: 0.9rem;">
                  Please start the Python API first:<br>
                  <code style="display: block; margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                    cd api-python<br>
                    pip install -r requirements.txt<br>
                    func start --port 7072
                  </code>
                </p>
                <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                  Error: ${healthError.message}
                </p>
              </div>
            `;
            return;
          }
        }

        const formData = new FormData();
        formData.append('image', file);

        let embedding, dimensions, confidence;

        if (selectedModel === 'insightface') {
          // Step 1: Generate InsightFace embedding (directly call Python API on port 7072)
          resultsDiv.innerHTML = '<div class="status loading">üîÑ Generating 512-dim InsightFace embedding...</div>';
          
          const generateResponse = await fetch('http://localhost:7072/api/generate-embeddings', {
            method: 'POST',
            body: formData
          });

          if (!generateResponse.ok) {
            const errorText = await generateResponse.text();
            console.error('Generate embeddings error:', errorText);
            resultsDiv.innerHTML = `<div class="status error">‚ùå API Error (${generateResponse.status}): ${errorText.substring(0, 200)}</div>`;
            return;
          }

          const generateData = await generateResponse.json();
          
          if (!generateData.success) {
            resultsDiv.innerHTML = `<div class="status error">‚ùå ${generateData.error || 'No face detected'}</div>`;
            return;
          }

          embedding = generateData.embedding;
          dimensions = generateData.dimensions;
          confidence = generateData.confidence;

          // Step 2: Match against database
          resultsDiv.innerHTML = '<div class="status loading">üîç Searching database for matches...</div>';
          
          const matchResponse = await fetch('http://localhost:7072/api/faces-identify-v2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              embedding: embedding,
              threshold: 0.3,
              topN: 10
            })
          });

          const matchData = await matchResponse.json();
          displayResults(matchData, 'insightface', confidence, dimensions);

        } else {
          // Use face-api.js (existing implementation)
          resultsDiv.innerHTML = '<div class="status error">‚ö†Ô∏è face-api.js testing not yet implemented in this harness. Use the main app for now.</div>';
        }

      } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    function displayResults(data, model, confidence, dimensions) {
      const resultsDiv = document.getElementById('results');
      
      let html = '<div class="status success">‚úÖ Analysis Complete</div>';
      
      // Stats
      html += '<div class="stats">';
      html += `<div class="stat-card"><div class="stat-value">${dimensions}</div><div class="stat-label">Dimensions</div></div>`;
      html += `<div class="stat-card"><div class="stat-value">${(confidence * 100).toFixed(1)}%</div><div class="stat-label">Detection</div></div>`;
      html += `<div class="stat-card"><div class="stat-value">${data.matches?.length || 0}</div><div class="stat-label">Matches Found</div></div>`;
      html += `<div class="stat-card"><div class="stat-value">${data.totalEmbeddings || 0}</div><div class="stat-label">DB Embeddings</div></div>`;
      html += '</div>';

      // Matches
      if (data.matches && data.matches.length > 0) {
        html += '<div class="result-card"><h4>Top Matches (using cosine similarity):</h4>';
        data.matches.forEach((match, idx) => {
          const similarity = match.similarity * 100;
          let scoreClass = 'low';
          if (similarity >= 50) scoreClass = '';
          else if (similarity >= 30) scoreClass = 'medium';
          
          html += `
            <div class="match-item">
              <div>
                <div class="match-name">${idx + 1}. ${match.personName}</div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                  Top-3 avg: ${(match.similarity * 100).toFixed(1)}% ‚Ä¢ 
                  Max: ${(match.maxSimilarity * 100).toFixed(1)}% ‚Ä¢ 
                  ${match.embeddingCount} training photos
                </div>
              </div>
              <div class="match-score ${scoreClass}">${similarity.toFixed(1)}%</div>
            </div>
          `;
        });
        html += '</div>';
      } else {
        html += '<div class="result-card"><h4>No matches found</h4><p style="color: #666;">Try lowering the threshold or training more faces.</p></div>';
      }

      // Info
      html += `<div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; font-size: 0.9rem; color: #0c5460;">
        <strong>‚ÑπÔ∏è About ${model === 'insightface' ? 'InsightFace' : 'face-api.js'}:</strong><br>
        ${model === 'insightface' 
          ? 'Uses cosine similarity (0-1 scale). Threshold: 0.3. Higher is better. Top-3 averaging reduces noise from poor quality training photos.'
          : 'Uses Euclidean distance with exponential decay. Threshold: 0.6. Based on 128-dim FaceNet embeddings.'
        }
      </div>`;

      resultsDiv.innerHTML = html;
    }
  </script>
</body>
</html>
