# Database Schema Documentation

This directory contains the database schema for the Family Album application.

## ⚠️ IMPORTANT: Schema Documentation

**Always refer to `CURRENT_SCHEMA.md` for the actual production database schema.**

This file is automatically generated from the Azure SQL database and represents the true source of truth for the current schema structure.

## Files in this Directory

### Current Schema (Source of Truth)

- **`CURRENT_SCHEMA.md`** - ✅ **THE AUTHORITATIVE SCHEMA REFERENCE**
  - Generated automatically by running `node scripts/get-schema.js`
  - Reflects the actual production database structure
  - Includes all tables, columns, indexes, and foreign keys
  - **Always check this file before writing SQL queries or making schema changes**

### Schema Creation Scripts

- **`schema.sql`** - Original base schema (may be outdated)
  - Creates the core tables: NameEvent, Pictures, NamePhoto, UnindexedFiles
  - ⚠️ This file may not reflect all current tables and columns

- **`users-permissions-schema.sql`** - User authentication and RBAC system
  - Creates Users table with roles (Admin, Full, Read)
  - Includes approval workflow tables

- **`face-embeddings-schema.sql`** - Face recognition data storage
  - FaceEmbeddings table for TensorFlow.js face recognition
  - Stores 128-dimensional face embeddings

- **`approval-tokens-schema.sql`** - Email approval tokens
  - ApprovalTokens table for secure email-based approvals

### Migration Scripts

- **`migration.sql`** - Database migration utilities
- **`add-date-columns.sql`** - Adds date tracking to Pictures table
- **`add-user-tracking-to-unindexed.sql`** - Adds uiUploadedBy column
- **`add-user-last-viewed-table.sql`** - Creates UserLastViewed table
- **`remove-npPosition.sql`** - Removes deprecated npPosition column
- **`fix-pnamecount.sql`** - Fixes PNameCount accuracy issues
- **`fix-file-paths.sql`** - Corrects file path corruption

### Utility Scripts

- **`queries.sql`** - Common database queries
- **`check-pnamecount-accuracy.sql`** - Validates PNameCount values

## Database Tables Overview

### Core Tables

1. **NameEvent** - People (neType='N') and Events (neType='E')
2. **Pictures** - Photos and videos with metadata
3. **NamePhoto** - Many-to-many relationship between people/events and media
4. **UnindexedFiles** - Staging area for newly uploaded files

### User Management Tables

5. **Users** - User accounts with roles and permissions
6. **ApprovalTokens** - Email-based approval tokens
7. **UserLastViewed** - Tracks last viewed time per user

### Face Recognition Tables

8. **FaceEmbeddings** - Face embeddings for client-side recognition (TensorFlow.js)
9. **FaceEncodings** - Face encodings for server-side recognition (legacy)
10. **PersonEncodings** - Aggregated face encodings per person (legacy)
11. **AzureFacePersons** - Azure Face API person mappings (legacy)
12. **FaceTrainingProgress** - Training session tracking
13. **FaceTrainingPhotoProgress** - Per-photo training progress

## How to Update Schema Documentation

When making schema changes:

1. **Make changes to the database** (via migration script or manual SQL)

2. **Regenerate the schema documentation:**
   ```bash
   node scripts/get-schema.js > database/CURRENT_SCHEMA.md
   ```
   
   Note: The script automatically uses:
   - Environment variables (AZURE_SQL_SERVER, etc.) if available (used by GitHub Copilot coding agent)
   - Falls back to `api/local.settings.json` for local development

3. **Commit both the migration script AND the updated CURRENT_SCHEMA.md:**
   ```bash
   git add database/your-migration-script.sql
   git add database/CURRENT_SCHEMA.md
   git commit -m "Add [feature]: update schema and regenerate documentation"
   ```

4. **Update this README if you add new tables or major changes**

## GitHub Secrets Configuration

Database credentials are stored as GitHub repository secrets for secure access by the Copilot coding agent:

- `AZURE_SQL_SERVER` - Database server hostname
- `AZURE_SQL_DATABASE` - Database name
- `AZURE_SQL_USER` - Database username
- `AZURE_SQL_PASSWORD` - Database password

To update secrets:
```bash
gh secret set AZURE_SQL_PASSWORD --body "your-new-password"
```

Local development uses `api/local.settings.json` instead.

## Schema Best Practices

1. ✅ **Always check CURRENT_SCHEMA.md before writing queries**
2. ✅ **Use parameterized queries to prevent SQL injection**
3. ✅ **Create migration scripts for schema changes**
4. ✅ **Regenerate CURRENT_SCHEMA.md after any schema change**
5. ✅ **Test schema changes on development database first**
6. ✅ **Use foreign keys to maintain referential integrity**
7. ✅ **Add indexes for frequently queried columns**

## Common Schema Queries

### Get all people and their photo counts:
```sql
SELECT ne.ID, ne.neName, ne.neCount
FROM NameEvent ne
WHERE ne.neType = 'N'
ORDER BY ne.neName
```

### Get all photos for a person:
```sql
SELECT p.PFileName, p.PYear, p.PMonth, p.PType
FROM Pictures p
INNER JOIN NamePhoto np ON p.PFileName = np.npFileName
WHERE np.npID = @personId
ORDER BY p.PYear DESC, p.PMonth DESC
```

### Get face training status:
```sql
SELECT 
    PersonID,
    COUNT(*) as EmbeddingCount,
    MAX(CreatedDate) as LastTraining
FROM FaceEmbeddings
GROUP BY PersonID
ORDER BY EmbeddingCount DESC
```

## Troubleshooting

### Schema out of sync?
Run the schema export script to get the current state:
```bash
node scripts/get-schema.js
```

### Need to see differences between documentation and database?
1. Check `CURRENT_SCHEMA.md` (actual database)
2. Compare with individual schema SQL files
3. Any differences indicate schema drift

### Database connection issues?
- Check `api/local.settings.json` for correct credentials
- Verify firewall rules allow your IP
- Ensure database is not paused (serverless tier)
